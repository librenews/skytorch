<!DOCTYPE html>
<html class="h-full bg-gray-50">
  <head>
    <title><%= content_for(:title) || "SkyTorch - Social AI Tools" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <link rel="icon" href="/favicon.svg?v=2" type="image/svg+xml">
    <link rel="icon" href="/favicon.ico?v=2" type="image/x-icon">
    <link rel="apple-touch-icon" href="/favicon.svg?v=2">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_include_tag "application", "data-turbo-track": "reload" %>
    
                <style>
              .thinking-dots .dot {
                animation: thinking 1.4s infinite;
                opacity: 0;
              }
              .thinking-dots .dot:nth-child(1) { animation-delay: 0s; }
              .thinking-dots .dot:nth-child(2) { animation-delay: 0.2s; }
              .thinking-dots .dot:nth-child(3) { animation-delay: 0.4s; }
              
              @keyframes thinking {
                0%, 60%, 100% { opacity: 0; }
                30% { opacity: 1; }
              }
              
              /* Custom scrollbar styles */
              .scrollbar-thin {
                scrollbar-width: thin;
                scrollbar-color: #d1d5db #f3f4f6;
              }
              
              .scrollbar-thin::-webkit-scrollbar {
                width: 8px;
              }
              
              .scrollbar-thin::-webkit-scrollbar-track {
                background: #f3f4f6;
                border-radius: 4px;
              }
              
              .scrollbar-thin::-webkit-scrollbar-thumb {
                background: #d1d5db;
                border-radius: 4px;
              }
              
              .scrollbar-thin::-webkit-scrollbar-thumb:hover {
                background: #9ca3af;
              }
              
              /* Force scrollbar to show */
              .force-scrollbar {
                overflow-y: scroll !important;
              }
              
              /* Always show scrollbar when content overflows */
              .always-show-scrollbar {
                overflow-y: scroll !important;
                scrollbar-gutter: stable;
              }
              
              /* Ensure scrollbar is visible */
              #chat-list-container {
                overflow-y: auto !important;
                scrollbar-width: thin;
                scrollbar-color: #d1d5db #f3f4f6;
              }
              
              #chat-list-container::-webkit-scrollbar {
                width: 8px;
              }
              
              #chat-list-container::-webkit-scrollbar-track {
                background: #f3f4f6;
                border-radius: 4px;
              }
              
              #chat-list-container::-webkit-scrollbar-thumb {
                background: #d1d5db;
                border-radius: 4px;
              }
              
              #chat-list-container::-webkit-scrollbar-thumb:hover {
                background: #9ca3af;
              }
              
              /* Collapsed sidebar styles */
              .sidebar-collapsed .sidebar-content {
                display: none;
              }
              
              .sidebar-collapsed .sidebar-header-content {
                display: none;
              }
              
              .sidebar-collapsed .chat-navigation-content {
                display: none;
              }
              
              .sidebar-collapsed .user-profile-content {
                display: none;
              }
              
              .sidebar-collapsed .user-profile-photo {
                display: block;
              }
              
              .sidebar-collapsed .user-profile-photo img,
              .sidebar-collapsed .user-profile-photo div {
                margin: 0 auto;
              }
              
              /* Hide collapse button when collapsed */
              .sidebar-collapsed #sidebar-collapse-btn {
                display: none;
              }
              
              /* Ensure icons are centered and aligned in collapsed state */
              .sidebar-collapsed .sidebar-header .flex {
                justify-content: center;
              }
              
              .sidebar-collapsed .chat-navigation .flex {
                justify-content: center;
              }
              
              .sidebar-collapsed .user-profile .flex {
                justify-content: center;
              }
              
              /* Give write icon more room in collapsed state */
              .sidebar-collapsed #new-chat-btn {
                padding: 0.75rem;
              }
              
              .sidebar-collapsed #new-chat-btn .w-10.h-10 {
                width: 2.5rem;
                height: 2.5rem;
              }
              
              /* Remove hover effects in collapsed state */
              .sidebar-collapsed #desktop-user-profile-btn:hover,
              .sidebar-collapsed #mobile-user-profile-btn:hover,
              .sidebar-collapsed #new-chat-btn:hover {
                background-color: transparent;
              }
              
              /* Ensure consistent vertical alignment */
              .sidebar-header .flex,
              .chat-navigation .flex,
              .user-profile .flex {
                align-items: center;
              }
              
              /* Consistent spacing in both states */
              .sidebar-header,
              .chat-navigation,
              .user-profile {
                padding: 1rem;
              }
              
              .sidebar-collapsed .sidebar-header,
              .sidebar-collapsed .chat-navigation,
              .sidebar-collapsed .user-profile {
                padding: 0.75rem;
              }
              
              /* Standardize all icon widths to ensure alignment */
              .sidebar-header .w-10.h-10,
              .chat-navigation .w-10.h-10,
              .user-profile .w-10.h-10 {
                width: 2.5rem;
                height: 2.5rem;
                flex-shrink: 0;
              }
              

              
              /* Adjust positioning for better alignment in collapsed state */
              .sidebar-collapsed .sidebar-header .flex {
                justify-content: center;
              }
              
              .sidebar-collapsed .chat-navigation .flex {
                justify-content: center;
              }
              
              .sidebar-collapsed .user-profile .flex {
                justify-content: center;
              }
              
              /* Ensure all three sections are properly centered */
              .sidebar-collapsed .sidebar-header,
              .sidebar-collapsed .chat-navigation,
              .sidebar-collapsed .user-profile {
                display: flex;
                justify-content: center;
                align-items: center;
              }
              
              /* Align left edges of all icons */
              .sidebar-collapsed .sidebar-header .flex,
              .sidebar-collapsed .chat-navigation .flex,
              .sidebar-collapsed .user-profile .flex {
                justify-content: flex-start;
                margin-left: 0.75rem;
              }
              
              /* Reduce padding on write icon and profile in collapsed state */
              .sidebar-collapsed #new-chat-btn {
                padding: 0.5rem;
              }
              
              .sidebar-collapsed #desktop-user-profile-btn,
              .sidebar-collapsed #mobile-user-profile-btn {
                padding: 0.5rem;
              }
              
              /* No CSS adjustments - using JavaScript instead */
              
              /* Tooltip styles */
              .tooltip {
                position: relative;
              }
              
              .tooltip::after {
                content: ">> " attr(data-tooltip);
                position: absolute;
                top: 50%;
                left: 100%;
                transform: translateY(-50%);
                background: #1f2937;
                color: white;
                padding: 0.5rem;
                border-radius: 0.375rem;
                font-size: 0.75rem;
                white-space: nowrap;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.2s;
                z-index: 50;
                margin-left: 0.75rem;
              }
              
              .tooltip:hover::after {
                opacity: 1;
              }
              

            </style>
    
    <script>
      console.log("JavaScript loaded successfully");
    </script>
  </head>

  <body class="h-full bg-white" data-controller="dashboard">
    <!-- Mobile Header -->
    <header class="lg:hidden bg-white border-b border-gray-200 px-4 py-3 sticky top-0 z-40">
      <div class="flex items-center justify-between">
        <!-- Logo/Back Button -->
        <div class="flex items-center space-x-3">
          <button id="mobile-back-btn" class="p-2 rounded-lg hover:bg-gray-100 transition-colors hidden">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </button>
          <div id="mobile-logo" class="flex items-center space-x-3">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-white rounded-lg flex items-center justify-center">
              <span class="text-lg">üöÄ</span>
            </div>
            <div>
              <h1 class="text-lg font-bold text-gray-900">SkyTorch</h1>
              <p class="text-xs text-gray-500">Social AI Tools</p>
            </div>
          </div>
          <div id="mobile-chat-info" class="flex items-center space-x-3 hidden">
            <div>
              <h2 id="mobile-chat-title" class="text-lg font-semibold text-gray-900">Chat Title</h2>
              <p id="mobile-chat-subtitle" class="text-xs text-gray-500">Chat Subtitle</p>
            </div>
          </div>
        </div>
        
        <!-- Mobile Menu Button / Chat Actions -->
        <div class="flex items-center space-x-2">
          <div id="mobile-chat-actions" class="hidden">
            <%= render 'chat_actions_menu', mobile: true %>
          </div>
          <button id="mobile-menu-btn" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Layout Container -->
    <div class="flex h-screen">
      <!-- Sidebar -->
      <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-80 lg:w-80 bg-white border-r border-gray-200 transform -translate-x-full transition-transform duration-300 ease-in-out lg:relative lg:translate-x-0 lg:z-auto h-screen">
        <!-- Desktop Sidebar Header -->
        <div class="hidden lg:block px-6 py-4 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <%= render 'dashboard/sidebar_header' %>
            <button id="sidebar-collapse-btn" class="p-2 rounded-lg hover:bg-gray-100 transition-colors" title="Collapse sidebar">
              <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Sidebar Content -->
        <div class="flex flex-col flex-1 min-h-0">
          <!-- Mobile Close Button -->
          <div class="lg:hidden px-4 py-3 border-b border-gray-200">
            <button id="mobile-close-btn" class="w-full flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 transition-colors">
              <span class="text-sm font-medium text-gray-700">Close Menu</span>
              <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>

          <!-- Sidebar Navigation -->
          <div class="flex-1 overflow-y-auto min-h-0">
            <%= render 'dashboard/chat_navigation' %>
          </div>

          <!-- User Profile -->
          <div class="lg:hidden sticky bottom-0 bg-white border-t border-gray-200">
            <%= render 'dashboard/user_profile', mobile: true %>
          </div>
          <div class="hidden lg:block border-t border-gray-200">
            <%= render 'dashboard/user_profile', mobile: false %>
          </div>
        </div>
      </aside>

      <!-- Mobile Overlay -->
      <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden"></div>

      <!-- Main Content Area -->
      <main class="flex-1 flex flex-col lg:ml-0">
        <!-- Desktop Header -->
        <header class="hidden lg:block">
          <%= render 'dashboard/chat_header' %>
        </header>

        <!-- Messages Area -->
        <div class="flex-1 overflow-y-auto">
          <%= yield %>
        </div>
        
        <!-- Message Input -->
        <%= render 'dashboard/message_input' %>
      </main>
    </div>

    <!-- Mobile Menu JavaScript -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileCloseBtn = document.getElementById('mobile-close-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobile-overlay');
        const sidebarCollapseBtn = document.getElementById('sidebar-collapse-btn');
        
        // Disable tooltip on initial load since sidebar starts expanded
        const rocketEmoji = document.querySelector('.w-10.h-10');
        if (rocketEmoji) {
          rocketEmoji.classList.remove('tooltip');
          rocketEmoji.removeAttribute('data-tooltip');
        }

        // Mobile menu toggle
        function openMobileMenu() {
          sidebar.classList.add('translate-x-0');
          sidebar.classList.remove('-translate-x-full');
          overlay.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }

        function closeMobileMenu() {
          sidebar.classList.remove('translate-x-0');
          sidebar.classList.add('-translate-x-full');
          overlay.classList.add('hidden');
          document.body.style.overflow = '';
        }

        // Event listeners
        mobileMenuBtn?.addEventListener('click', openMobileMenu);
        mobileCloseBtn?.addEventListener('click', closeMobileMenu);
        overlay?.addEventListener('click', closeMobileMenu);

        // Desktop sidebar collapse
        console.log("üîç Sidebar collapse button found:", sidebarCollapseBtn);
        sidebarCollapseBtn?.addEventListener('click', function() {
          console.log("üéØ Sidebar collapse button clicked!");
          if (sidebar.classList.contains('lg:w-80')) {
            sidebar.classList.remove('lg:w-80');
            sidebar.classList.add('lg:w-22', 'sidebar-collapsed');
            console.log("üìè Sidebar collapsed to 88px");
            adjustLayoutForCollapsedSidebar();
          } else {
            sidebar.classList.remove('lg:w-22', 'sidebar-collapsed');
            sidebar.classList.add('lg:w-80');
            console.log("üìè Sidebar expanded to 320px");
            adjustLayoutForExpandedSidebar();
          }
          console.log("üìè Sidebar width classes after toggle:", sidebar.className);
        });
        
        // Function to adjust layout when sidebar is collapsed
        function adjustLayoutForCollapsedSidebar() {
          const messageInput = document.querySelector('#message-input-container');
          const mainContent = document.querySelector('main');
          const chatHeader = document.querySelector('#chat-header');
          
          if (messageInput) {
            messageInput.style.left = '5.5rem'; // 88px = 5.5rem
            messageInput.style.width = 'calc(100vw - 5.5rem)';
            // Center the form field within the container
            const form = messageInput.querySelector('form');
            if (form) {
              form.style.maxWidth = '48rem'; // 768px - reasonable max width
              form.style.margin = '0 auto';
            }
          }
          if (mainContent) {
            mainContent.style.marginLeft = '5.5rem';
          }
          if (chatHeader) {
            chatHeader.style.width = 'calc(100vw - 5.5rem)';
            chatHeader.style.marginLeft = '5.5rem';
          }
          
          // Enable tooltip when sidebar is collapsed
          const rocketEmoji = document.querySelector('.w-10.h-10');
          if (rocketEmoji) {
            rocketEmoji.classList.add('tooltip');
            rocketEmoji.setAttribute('data-tooltip', 'Open sidebar');
          }
        }
        
        // Function to reset layout for mobile view
        function resetLayoutForMobile() {
          const messageInput = document.querySelector('#message-input-container');
          const mainContent = document.querySelector('main');
          const chatHeader = document.querySelector('#chat-header');
          
          if (messageInput) {
            messageInput.style.left = '0';
            messageInput.style.width = '100%';
          }
          if (mainContent) {
            mainContent.style.marginLeft = '0';
          }
          if (chatHeader) {
            chatHeader.style.width = '100%';
            chatHeader.style.marginLeft = '0';
          }
        }
        
        // Function to adjust layout when sidebar is expanded
        function adjustLayoutForExpandedSidebar() {
          const messageInput = document.querySelector('#message-input-container');
          const mainContent = document.querySelector('main');
          const chatHeader = document.querySelector('#chat-header');
          
          if (messageInput) {
            messageInput.style.left = '20rem'; // 320px = 20rem
            messageInput.style.width = 'calc(100vw - 20rem)';
            // Center the form field within the container
            const form = messageInput.querySelector('form');
            if (form) {
              form.style.maxWidth = '48rem'; // 768px - reasonable max width
              form.style.margin = '0 auto';
            }
          }
          if (mainContent) {
            mainContent.style.marginLeft = '0';
          }
          if (chatHeader) {
            chatHeader.style.width = 'calc(100vw - 20rem)';
            chatHeader.style.marginLeft = '0';
          }
          
          // Disable tooltip when sidebar is expanded
          const tooltip = document.querySelector('.tooltip');
          if (tooltip) {
            tooltip.classList.remove('tooltip');
            tooltip.removeAttribute('data-tooltip');
          }
        }

        // Rocket emoji click to expand sidebar - simplified approach
        document.addEventListener('click', function(e) {
          // Skip if clicking on the collapse button
          if (e.target.closest('#sidebar-collapse-btn')) {
            return;
          }
          
          console.log("üîç Click detected on:", e.target);
          console.log("üîç Target element:", e.target);
          console.log("üîç Target classes:", e.target.className);
          console.log("üîç Sidebar collapsed:", sidebar.classList.contains('sidebar-collapsed'));
          
          // Check if we clicked on the rocket emoji in collapsed state
          console.log("üîç Checking rocket emoji click...");
          console.log("üîç Target closest w-10.h-10:", e.target.closest('.w-10.h-10'));
          
          if (e.target.closest('.w-10.h-10') && sidebar.classList.contains('sidebar-collapsed')) {
            console.log("üöÄ Rocket emoji clicked to expand sidebar");
            sidebar.classList.remove('lg:w-22', 'sidebar-collapsed');
            sidebar.classList.add('lg:w-80');
            adjustLayoutForExpandedSidebar();
            return;
          }
          
          console.log("‚ùå Click was not on rocket emoji in collapsed sidebar");
        });

        // Close mobile menu on escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            closeMobileMenu();
          }
        });
        
        // Handle resize events for mobile/desktop transitions
        window.addEventListener('resize', function() {
          if (window.innerWidth < 1024) { // lg breakpoint
            resetLayoutForMobile();
          } else if (sidebar.classList.contains('sidebar-collapsed')) {
            adjustLayoutForCollapsedSidebar();
          } else {
            adjustLayoutForExpandedSidebar();
          }
        });


      });
    </script>
  </body>
</html>